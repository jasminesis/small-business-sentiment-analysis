---
title: "reviews"
format: html
---

```{r}
library(jsonlite)
library(tidyverse)

load("reviews.RData")
```


# Load data

The files are from https://datarepo.eng.ucsd.edu/mcauley_group/gdrive/googlelocal/

in the format where

user_id - ID of the reviewer
name - name of the reviwer
time - time of the review (unix time)
rating - rating of the business
text - text of the review
pics - pictures of the review
resp - business response to the review including unix time and text of the response
gmap_id - ID of the business

and crosslink with gmap_id in metadata where

name - name of the business
address - address of the business
gmap_id - ID of the business
description - description of the business
latitude - latitude of the business
longitude - longitude of the business
category - category of the business
avg_rating - average rating of the business
num_of_reviews - number of reviews
price - price of the business
hours - open hours
MISC - MISC information
state - the current status of the business (e.g., permanently closed)
relative_results - relative businesses recommended by Google
url - URL of the business


```{r}
meta_file <- "review_data/meta-New_York.json"
meta_json <- purrr::map(readLines(meta_file), jsonlite::fromJSON, .progress = "loading metadata")
select_columns <- function(x) {
  cbind(x$name, x$gmap_id, x$address, paste(x$category, collapse = ", "))
}
l <- map(meta_json, select_columns)

# this only works because it tends to be category that is empty, so it is filled with NA
padded_data_list <- lapply(l, function(x) {
  max_length <- 4
  ifelse(length(x) < max_length, c(x, rep(NA, max_length - length(x))), x)
}
d_meta <- data.frame(matrix(unlist(padded_data_list), ncol = 4, byrow = TRUE))
colnames(d_meta) <- c("name", "gmap_id", "address", "category")
d_meta <- tibble(d_meta)

small_businesses <- read_csv("review_data/SBS_Certified_Business_List_20240309.csv")
small_businesses$name <- small_businesses$Vendor_Formal_Name
joined <- inner_join(small_businesses, d_meta)
# 67 common establishments between the two!
```

```{r}
filepaths <- list.files(path = "review_data_split")
meta_json <- purrr::map(readLines(meta_file), jsonlite::fromJSON, .progress = "loading metadata")


```